#!/usr/bin/env bash
# Pre-commit hook: format then test.
# Install via: make install-hooks

set -e

echo "==> Formatting code..."

# Snapshot staged tracked files before formatting.
staged_files="$(mktemp -t kaku-precommit-staged.XXXXXX)"
git diff --cached --name-only --diff-filter=ACMR -z > "$staged_files"

cargo +nightly fmt -p kaku -p kaku-gui -p mux -p wezterm-term -p termwiz -p config -p wezterm-font

# Re-stage only files that were already staged before formatting.
while IFS= read -r -d '' file; do
  if [ -f "$file" ]; then
    git add "$file"
  fi
done < "$staged_files"
rm -f "$staged_files"

# If formatting changed unstaged tracked files, stop and ask user to review.
if ! git diff --quiet; then
  echo "Formatting modified unstaged files. Please review and stage them explicitly."
  git diff --name-only
  exit 1
fi

echo "==> Running tests..."
cargo nextest run
cargo nextest run -p wezterm-escape-parser

echo "==> All checks passed."
